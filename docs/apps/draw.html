<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>M5AtomKhey</title>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
    <style>
        table {
            border-spacing: 1px;
            border:20px solid grey;
            border-radius:10px;
        }
        td {
            border-style: solid;

            border-image-repeat: repeat;
            border-image-slice: 6 6 6 6;
            border-image-width: 18px;
            background-color: black;
            border-width: 15px;
            width:64px;
            height:64px;
        }
    </style>
</head>
<body>
    <table>
        <tr>
            <td onclick="draw(this,20)"></td>
            <td onclick="draw(this,15)"></td>
            <td onclick="draw(this,10)"></td>
            <td onclick="draw(this,5)"></td>
            <td onclick="draw(this,0)"></td>
        </tr>
        <tr>
            <td onclick="draw(this,21)"></td>
            <td onclick="draw(this,16)"></td>
            <td onclick="draw(this,11)"></td>
            <td onclick="draw(this,6)"></td>
            <td onclick="draw(this,1)"></td>
        </tr>
        <tr>
            <td onclick="draw(this,22)"></td>
            <td onclick="draw(this,17)"></td>
            <td onclick="draw(this,12)"></td>
            <td onclick="draw(this,7)"></td>
            <td onclick="draw(this,2)"></td>
        </tr>
        <tr>
            <td onclick="draw(this,23)"></td>
            <td onclick="draw(this,18)"></td>
            <td onclick="draw(this,13)"></td>
            <td onclick="draw(this,8)"></td>
            <td onclick="draw(this,3)"></td>
        </tr>
        <tr>
            <td onclick="draw(this,24)"></td>
            <td onclick="draw(this,19)"></td>
            <td onclick="draw(this,14)"></td>
            <td onclick="draw(this,9)"></td>
            <td onclick="draw(this,4)"></td>
        </tr>
    </table>
    <input id="color_picker" onchange="change_color(this)" type="color">
    <input type="text" id="value" style="width:100%;" value="">
    <button onclick="send(true);">â¬› Send</button>
    <button onclick="save()">ðŸ’¾ Save</button>
    <div id="qrcode"></div>
    <div id="error"></div>
    <script src="qrcode.min.js"></script>
    <script>

    matrix = []
    color="255;255;255";
    color_hex = "#ffffff";
    if(document.URL.split("ip=")[1] !== undefined){
        localStorage.setItem("m5atom_ip",document.URL.split("ip=")[1]);
        console.log("IP: "+document.URL.split("ip=")[1]);
    }

    address = localStorage.getItem("m5atom_ip");
    if(address == null){
        address = prompt("IP","");
    }

    command = "";
    document.getElementById("error").innerHTML = address;

    presets = JSON.parse(localStorage.getItem("m5atom_preset"));
    if(presets == null){
        presets = [];
    }
    function change_color(obj){
        console.log(obj.value);
        color = obj.value.convertToRGB();
        color_hex = obj.value;
        console.log(color);
    }

    function save() {
        presets.push(matrix);
        localStorage.setItem("m5atom_preset",JSON.stringify(presets));

    }

   //https://javascript.plainenglish.io/convert-hex-to-rgb-with-javascript-4984d16219c3
    String.prototype.convertToRGB = function(){
        string = this;
        string = string.substring(1);

        if(string.length != 6){
            throw "Only six-digit hex colors are allowed.";
        }

        var aRgbHex = string.match(/.{1,2}/g);
        var aRgb = parseInt(aRgbHex[0], 16) +";" + parseInt(aRgbHex[1], 16) + ";" + parseInt(aRgbHex[2], 16);
        return aRgb;
    }

    for(i=0;i<25;i++){
        matrix[i] = "0;0;0";
    }

    qrcode = new QRCode(document.getElementById("qrcode"), {
        text: "http://" + address + "/draw?param=" + command,
        correctLevel: QRCode.CorrectLevel.L
        });
    setCommand();
    function setCommand() {
        createCommand()
        qrcode.clear();
        qrcode.makeCode("http://" + address + "/draw?param=" + command);
        document.getElementById("value").value = "http://" + address + "/draw?param=" + command;
    }
    send();
    function draw(obj, nb) {
        console.log(matrix[nb]);
        if(matrix[nb] != color){
            obj.style="background-color:" + color_hex;
            matrix[nb] = color;
        } else {
            obj.style="background-color: #000000" ;
            matrix[nb] = "0;0;0";
        }
        console.log(nb);
        setCommand();
        send(false);
    }

    function createCommand(){
        str = ""
        for(i=0;i<25;i++){
            if(i==24){
                split = ""
            } else {
                split = ";";
            }
            str += matrix[i] + split;
        }
        command = str;
    }

    async function send() {
        url = document.getElementById("value").value;
        console.log(url);
        fetch(url).catch(function(error) {
            console.log("RESEND NEED");
            document.getElementById("error").innerHTML = error;
        });

    }
</script>
</body>
